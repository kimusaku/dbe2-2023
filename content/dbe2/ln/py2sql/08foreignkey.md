+++
title = "(補足) 外部キー制約"
description = ""
weight = 8
alwaysopen = true
+++

外部キー制約については，情報基礎演習III で扱っているはずだと思うが，
念のため説明する．

## 外部キー

この講義資料で使用しているデータベース dbe2 の
テーブル 「貸出」を参照されたい．
そのフィールド「書籍」には，BK000426 だの BK001519 だのの文字列が
並んでいる．これらの文字列はもちろん単独では意味がない．
これらは，別のテーブル「書籍」のフィールド「書籍ID」の
値なのである．つまり，「貸出」テーブルの「書籍フィールド」に，
文字列 `'BK000426'` が格納されているときには，実態としての
「書籍」フィールドの1つのレコード (その「書籍ID」フィールドの
値が `'BK000426'` であるようなレコード) を指し示しているのである．

このような事情であるから，「貸出」テーブルの「書籍」フィールドに
でたらめな値，たとえば `'蜘蛛の糸'` のような文字列が設定されるのは
よろしくない．そのようなことが有り得るかもしれない，となると，
その事態に対処するために，
アプリケーションはいろいろ気を配らなくならねばなって，たいへんである．
データベースが「そういうことは心配しなくて大丈夫です．
『貸出』テーブルの『書籍』フィールドに格納されている文字列は，必ず，
『書籍』テーブルの『書籍ID』フィールドに (ただ1度だけ) 値として現れます．」
と言ってくれれば，アプリケーションを書く者の負担は軽減される．
(その分，データベースは大きなコストを払って，この保障を実現する．)

## 外部キー制約

これを実現するための仕組みが，
__外部キー制約__ (foreign key constraint) である．
データベース dbe2 では，次のように指定されている:

```sql
CREATE TABLE 書籍 (
  書籍ID CHAR(8) PRIMARY KEY,
  ... (略) ...
) ... (略) ...

CREATE TABLE 貸出 (
  ... (略) ...,
  書籍 CHAR(8) NOT NULL,
  ... (略) ...,
  FOREIGN KEY (書籍)   REFERENCES 書籍(書籍ID)
) ... (略) ...
```

貸出テーブルの方では，FOREIGN KEY キーワードによって，
このテーブルの書籍フィールドが，
書籍テーブルの書籍IDフィールドを指さねばならないことを宣言しており，
書籍テーブルの方では，書籍IDフィールドを主キーに指定することで，
同じ値が2回使われないことを宣言している．

## 制約違反

したがって，その制約に違反するような操作は行えない．
行おうとするとエラーになる．

たとえば，貸出テーブルに，書籍フィールドの値が`'蜘蛛の糸'`で
あるようなレコードを作成しようとすると，書籍テーブルには書籍IDフィールドに
そんな面妖な値を持つレコードは存在しないから，エラーになる:

```python
with connect_db() as cursor:
    cursor.execute("INSERT INTO 貸出('書籍') VALUES('蜘蛛の糸')", [])
```

```
---------------------------------------------------------------------------
IntegrityError                            Traceback (most recent call last)
Input In [17], in <cell line: 1>()
      1 with connect_db() as cursor:
----> 2     cursor.execute("INSERT INTO 貸出(書籍) VALUES ('蜘蛛の糸')", [])

... (略) ...

IntegrityError: (1452, 'Cannot add or update a child row: a foreign key
constraint fails (`dbe2`.`貸出`, CONSTRAINT `貸出_ibfk_1` FOREIGN KEY
(`利用者`) REFERENCES `利用者` (`利用者ID`))')
```

以上のような事情であるから，「IntegrityError」と言われたら，
外部キー制約，主キー制約，一意性制約などがどのようになっているのか，
確認しなければならない．

