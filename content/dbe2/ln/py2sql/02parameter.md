+++
title = "パラメタのあるSelect文"
description = ""
weight = 2
alwaysopen = true
+++


## パラメタの処理 -- 悪い例

前節 func23(s) の改良を考えよう．たとえば `func23('d02')` が
呼ばれたとき，func23 で実行されるのは，次のSQL文である．

```sql
SELECT fld10, fld13 FROM tbl1
```

したがって，tbl1 の全レコード (のうちの，fld10 と fld13 の値)
が，データベースサーバから Python に渡されてしまい，Python の
側で，ほしいレコード (fld10 の値が `'d02'` であるレコード) を
探す羽目になっていた．

そうではなく，次のSQL文が実行されるのが望ましい．

```sql
SELECT fld13 FROM tbl1 WHERE fld10 = 'd02'
```

これならば，データベースサーバ側で，
条件を満たすただ一つのレコードを取り出した上で Python に渡してくれるので，
ずっと効率が良い．

問題は，`d02` の部分である．これは関数に渡される引数 s の
値であるから，原理的には次のように書くこともできる．

```python
	sql = "SELECT fld13 FROM tbl1 WHERE fld10 = '" + s + "'"
```

しかし，実際のアプリケーションでこのようなコードを書くと，システムの
___セキュリティ上の致命的な問題___ をもたらすことが多い．
一般に，「引数で渡された文字列を，SQL文の一部として使う」ことが
問題を引き起こす (例外はある)．
この点は，ウェブアプリケーションへの応用の際に再検討する．

一応，___悪い例___ として，全体のコードを掲載しておく．

```python
### 注: このコードには，セキュリティ上の問題がある．実運用で動かすべきではない．
def func24(s):
    with connect_db() as cursor:
        sql = "SELECT fld13 FROM tbl1 WHERE fld10 = '" + s + "'"       # (A)
        cursor.execute(sql, [])
        for c in cursor:                 # (B)
            return c[0]                  # (C)
```

フィールド fld10 は，tbl1 の主キーであるから，
(B) のループでは，たかだか1件のレコードしか含まれていない．
したがって，ループの中に入ってくれば，それが欲しいレコードであるので，
if 文などを書かずにいきなり return することができる．
今回は，取得しているフィールドは fld13 だけであるから，
(C)では，第0要素を返すことになる．

悪い例を真似せよという練習問題で気が引けるが，一応解いてみてもらいたい:

{% exc seq="3-1" %}

練習2-3 の (1), (2), (3) を，上の例にならって修正せよ．

{% /exc %}

## パラメタの処理 -- 正しい方法

与えられた引数を処理する場合には，上のように文字列を組み立てるのではなく，
プレースホルダーを利用するのが正しい．例を示す．

```python
def func25(s):
    with connect_db() as cursor:
        sql = "SELECT fld13 FROM tbl1 WHERE fld10 = %s"       # (A)
        cursor.execute(sql, [s])         #(B)
        for c in cursor:
            return c[0]
```

(A), (B) 以外は，func24 と同じコードである．

(A) のSQL文にある `%s` がプレースホルダーである．
「s」は，引数の s とは関係なく，いつでも `%s` と表記するものである．
この `%s` は，「実際にはこの位置にパラメタが入る」ことを示す．
func24で必要であった，SQLの単一引用符がなくなっていることに注意されたい．

実際のパラメタの値は，executeメソッドで与える．
コードの(B)で示すように，executeメソッド第2引数として，
`%s` の位置で実際に使うべき値 (ここでは引数 s の値) が指定されている．

{% exc seq="3-2" %}

練習3-1を，プレースホルダーを用いて修正せよ．

{% /exc %}

## 複数のプレースホルダー

プレースホルダーは複数個置くことができる．
整数の引数 m と n をとり，fld11 の値が m 以上 n 以下であるレコードの
fld10 の値のリストを返す関数 func26(m, n) は，以下のように書ける．

```python
def func26(m, n):
    with connect_db() as cursor:
        sql = "SELECT fld10 FROM tbl1 WHERE fld11 >= %s AND fld11 <= %s"     # (A)
        cursor.execute(sql, [m, n])
        result = []                      # (B)
        for c in cursor:
            result.append(c[0])          # (C)
    return result
```

コードの(A)に示すように，値を後から設定すべき場所に，
プレースホルダー `%s` を置く．
実際の値である m と n は，リストにして execute メソッドに与える．
SQL文の中で現れるのと同一の順序でリストにする必要がある．
なお，func25で見たように，プレースホルダーが1つの場合でも，
executeメソッドの第2引数には，(1要素からなる) リストを与える必要がある．

複数のレコードが条件に合致する可能性があるので，func26はリス
トを返すことにしている．(B)で空リスト result を作り，cursor の
ループ中の (C) でresult に値を加えている．

{% exc seq="3-3" %}

(1) 整数の引数x と y をとり，fld23の値がx以上y以下であるような tbl2 の
レコードのfld21の値からなるリストを返す関数を書け．

(2) 文字列の引数 s1, s2, s3 をとり，fld24 の値が s1, s2, s3 の
いずれかと一致するような tbl2 のレコードの fld21 の値からなるリストを
返す関数を書け．

{% /exc %}



